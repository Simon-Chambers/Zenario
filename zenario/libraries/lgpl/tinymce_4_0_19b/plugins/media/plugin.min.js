tinymce.PluginManager.add("media",function(c,w){function s(a){return-1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function q(a){var b=c.settings.media_scripts;if(b)for(var g=0;g<b.length;g++)if(-1!==a.indexOf(b[g].filter))return b[g]}function t(){function a(a){var e,l,d,h;e=b.find("#width")[0];l=b.find("#height")[0];
d=e.value();h=l.value();b.find("#constrain")[0].checked()&&g&&m&&d&&h&&(a.control==e?(h=Math.round(d/g*h),l.value(h)):(d=Math.round(h/m*d),e.value(d)));g=d;m=h}var b,g,m,f;f=x(c.selection.getNode());g=f.width;m=f.height;b=c.windowManager.open({title:"Insert/edit video",data:f,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){f=r(this.next().find("#embed").value());this.fromJSON(f)},items:[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source"},
{name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"},{name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"},{type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,ariaLabel:"Width",onchange:a},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,ariaLabel:"Height",onchange:a},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}]},
{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(u(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},{id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:y(),multiline:!0,label:"Source"}]}],onSubmit:function(){c.insertContent(u(this.toJSON()))}})}function y(){if(c.selection.getNode().getAttribute("data-mce-object"))return c.selection.getContent()}
function u(a){var b="";if(!a.source1&&(tinymce.extend(a,r(a.embed)),!a.source1))return"";a.source1=c.convertURL(a.source1,"source");a.source2=c.convertURL(a.source2,"source");a.source1mime=s(a.source1);a.source2mime=s(a.source2);a.poster=c.convertURL(a.poster,"poster");a.flashPlayerUrl=c.convertURL(w+"/moxieplayer.swf","movie");if(a.embed)b=v(a.embed,a,!0);else{tinymce.each(z,function(b){var g,c,e;if(g=b.regex.exec(a.source1)){e=b.url;for(c=0;g[c];c++)e=e.replace("$"+c,function(){return g[c]});a.source1=
e;a.type=b.type;a.width=a.width||b.w;a.height=a.height||b.h}});var g=q(a.source1);g&&(a.type="script",a.width=g.width,a.height=g.height);a.width=a.width||300;a.height=a.height||150;tinymce.each(a,function(b,g){a[g]=c.dom.encode(b)});"iframe"==a.type?b+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"></iframe>':"application/x-shockwave-flash"==a.source1mime?(b+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',a.poster&&
(b+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),b+="</object>"):b=-1!=a.source1mime.indexOf("audio")?c.settings.audio_template_callback?c.settings.audio_template_callback(a):b+('<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>"):"script"==a.type?b+('<script src="'+a.source1+'">\x3c/script>'):c.settings.video_template_callback?c.settings.video_template_callback(a):
'<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n<source src="'+a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"}return b}function r(a){var b={};(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(a,c){b.source1||"param"!=a||(b.source1=c.map.movie);
if("iframe"==a||"object"==a||"embed"==a||"video"==a||"audio"==a)b.type||(b.type=a),b=tinymce.extend(c.map,b);if("script"==a){var f=q(c.map.src);if(!f)return;b={type:"script",source1:c.map.src,width:f.width,height:f.height}}"source"==a&&(b.source1?b.source2||(b.source2=c.map.src):b.source1=c.map.src);"img"!=a||b.poster||(b.poster=c.map.src)}})).parse(a);b.source1=b.source1||b.src||b.data;b.source2=b.source2||"";b.poster=b.poster||"";return b}function x(a){return a.getAttribute("data-mce-object")?r(c.serializer.serialize(a,
{selection:!0})):{}}function v(a,b,c){function m(a,b){var c,g,e,f;for(c in b)if(e=""+b[c],a.map[c])for(g=a.length;g--;)f=a[g],f.name==c&&(e?(a.map[c]=e,f.value=e):(delete a.map[c],a.splice(g,1)));else e&&(a.push({name:c,value:e}),a.map[c]=e)}var f=new tinymce.html.Writer,k=0,e;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(a){f.comment(a)},cdata:function(a){f.cdata(a)},text:function(a,b){f.text(a,b)},start:function(a,d,h){switch(a){case "video":case "object":case "embed":case "img":case "iframe":m(d,
{width:b.width,height:b.height})}if(c)switch(a){case "video":m(d,{poster:b.poster,src:""});b.source2&&m(d,{src:""});break;case "iframe":m(d,{src:b.source1});break;case "source":k++;if(2>=k&&(m(d,{src:b["source"+k],type:b["source"+k+"mime"]}),!b["source"+k]))return;break;case "img":if(!b.poster)return;e=!0}f.start(a,d,h)},end:function(a){if("video"==a&&c)for(var d=1;2>=d;d++)if(b["source"+d]){var h=[];h.map={};k<d&&(m(h,{src:b["source"+d],type:b["source"+d+"mime"]}),f.start("source",h,!0))}b.poster&&
"object"==a&&c&&!e&&(d=[],d.map={},m(d,{src:b.poster,width:b.width,height:b.height}),f.start("img",d,!0));f.end(a)}},new tinymce.html.Schema({}))).parse(a);return f.getContent()}var z=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},
{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];c.on("ResolveName",function(a){var b;1==a.target.nodeType&&(b=a.target.getAttribute("data-mce-object"))&&(a.name=b)});c.on("preInit",function(){var a=c.schema.getSpecialElements();tinymce.each(["video","audio","iframe","object"],function(b){a[b]=RegExp("</"+b+"[^>]*>","gi")});c.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");
var b=c.schema.getBoolAttrs();tinymce.each(["webkitallowfullscreen","mozallowfullscreen","allowfullscreen"],function(a){b[a]={}});c.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(a,b){for(var f=a.length,k,e,l,d,h,n,p;f--;){e=a[f];if("script"==e.name&&(p=q(e.attr("src")),!p))continue;l=new tinymce.html.Node("img",1);l.shortEnded=!0;p&&(p.width&&e.attr("width",p.width.toString()),p.height&&e.attr("height",p.height.toString()));n=e.attributes;for(k=n.length;k--;)if(d=n[k].name,
h=n[k].value,"width"!==d&&"height"!==d&&"style"!==d){if("data"==d||"src"==d)h=c.convertURL(h,d);l.attr("data-mce-p-"+d,h)}if(k=e.firstChild&&e.firstChild.value)l.attr("data-mce-html",escape(k)),l.firstChild=null;l.attr({width:e.attr("width")||"300",height:e.attr("height")||("audio"==b?"30":"150"),style:e.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":b,"class":"mce-object mce-object-"+b});e.replace(l)}});c.serializer.addAttributeFilter("data-mce-object",function(a,b){for(var c=a.length,
k,e,l,d,h;c--;){k=a[c];h=k.attr(b);e=new tinymce.html.Node(h,1);"audio"!=h&&"script"!=h&&e.attr({width:k.attr("width"),height:k.attr("height")});e.attr({style:k.attr("style")});d=k.attributes;for(l=d.length;l--;){var n=d[l].name;0===n.indexOf("data-mce-p-")&&e.attr(n.substr(11),d[l].value)}"script"==h&&e.attr("type","text/javascript");if(l=k.attr("data-mce-html"))d=new tinymce.html.Node("#text",3),d.raw=!0,d.value=unescape(l),e.append(d);k.replace(e)}})});c.on("ObjectSelected",function(a){var b=a.target.getAttribute("data-mce-object");
"audio"!=b&&"script"!=b||a.preventDefault()});c.on("objectResized",function(a){var b=a.target,c;b.getAttribute("data-mce-object")&&(c=b.getAttribute("data-mce-html"))&&(c=unescape(c),b.setAttribute("data-mce-html",escape(v(c,{width:a.width,height:a.height}))))});c.addButton("media",{tooltip:"Insert/edit video",onclick:t,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]});c.addMenuItem("media",{icon:"media",text:"Insert video",onclick:t,context:"insert",prependToContext:!0})});
