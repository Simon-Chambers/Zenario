tinymce.PluginManager.add("fullpage",function(e){function r(){var a=p(),d={},c;d.fontface=e.getParam("fullpage_default_fontface","");d.fontsize=e.getParam("fullpage_default_fontsize","");c=a.firstChild;7==c.type&&(d.xml_pi=!0,c=/encoding="([^"]+)"/.exec(c.value))&&(d.docencoding=c[1]);if(c=a.getAll("#doctype")[0])d.doctype="<!DOCTYPE"+c.value+">";(c=a.getAll("title")[0])&&c.firstChild&&(d.title=c.firstChild.value);n(a.getAll("meta"),function(a){var c=a.attr("name"),e=a.attr("http-equiv");c?d[c.toLowerCase()]=
a.attr("content"):"Content-Type"==e&&(a=/charset\s*=\s*(.*)\s*/gi.exec(a.attr("content")))&&(d.docencoding=a[1])});if(c=a.getAll("html")[0])d.langcode=c.attr("lang")||""||c.attr("xml:lang")||"";d.stylesheets=[];tinymce.each(a.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&d.stylesheets.push(a.attr("href"))});if(c=a.getAll("body")[0])d.langdir=c.attr("dir")||"",d.style=c.attr("style")||"",d.visited_color=c.attr("vlink")||"",d.link_color=c.attr("link")||"",d.active_color=c.attr("alink")||"";
return d}function s(a){function d(a,b,c){a.attr(b,c?c:void 0)}function c(a){f.firstChild?f.insert(a,f.firstChild):f.append(a)}var g,f,h,b,t=e.dom;g=p();f=g.getAll("head")[0];f||(b=g.getAll("html")[0],f=new l("head",1),b.firstChild?b.insert(f,b.firstChild,!0):b.append(f));b=g.firstChild;a.xml_pi?(h='version="1.0"',a.docencoding&&(h+=' encoding="'+a.docencoding+'"'),7!=b.type&&(b=new l("xml",7),g.insert(b,g.firstChild,!0)),b.value=h):b&&7==b.type&&b.remove();b=g.getAll("#doctype")[0];a.doctype?(b||
(b=new l("#doctype",10),a.xml_pi?g.insert(b,g.firstChild):c(b)),b.value=a.doctype.substring(9,a.doctype.length-1)):b&&b.remove();b=null;n(g.getAll("meta"),function(a){"Content-Type"==a.attr("http-equiv")&&(b=a)});a.docencoding?(b||(b=new l("meta",1),b.attr("http-equiv","Content-Type"),b.shortEnded=!0,c(b)),b.attr("content","text/html; charset="+a.docencoding)):b.remove();b=g.getAll("title")[0];a.title?(b?b.empty():(b=new l("title",1),c(b)),b.append(new l("#text",3)).value=a.title):b&&b.remove();n(["keywords",
"description","author","copyright","robots"],function(d){var e=g.getAll("meta"),f,h,k=a[d];for(f=0;f<e.length;f++)if(h=e[f],h.attr("name")==d){k?h.attr("content",k):h.remove();return}k&&(b=new l("meta",1),b.attr("name",d),b.attr("content",k),b.shortEnded=!0,c(b))});var k={};tinymce.each(g.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&(k[a.attr("href")]=a)});tinymce.each(a.stylesheets,function(a){k[a]||(b=new l("link",1),b.attr({rel:"stylesheet",text:"text/css",href:a}),b.shortEnded=!0,c(b));
delete k[a]});tinymce.each(k,function(a){a.remove()});if(b=g.getAll("body")[0])d(b,"dir",a.langdir),d(b,"style",a.style),d(b,"vlink",a.visited_color),d(b,"link",a.link_color),d(b,"alink",a.active_color),t.setAttribs(e.getBody(),{style:a.style,dir:a.dir,vLink:a.visited_color,link:a.link_color,aLink:a.active_color});if(b=g.getAll("html")[0])d(b,"lang",a.langcode),d(b,"xml:lang",a.langcode);f.firstChild||f.remove();h=(new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",
indent_after:"head,html,body,meta,title,script,link,style"})).serialize(g);m=h.substring(0,h.indexOf("</body>"))}function p(){return(new tinymce.html.DomParser({validate:!1,root_name:"#document"})).parse(m)}function u(){var a="",d,c="";e.getParam("fullpage_default_xml_pi")&&(a+='<?xml version="1.0" encoding="'+e.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n');a+=e.getParam("fullpage_default_doctype","<!DOCTYPE html>");a+="\n<html>\n<head>\n";if(d=e.getParam("fullpage_default_title"))a+=
"<title>"+d+"</title>\n";if(d=e.getParam("fullpage_default_encoding"))a+='<meta http-equiv="Content-Type" content="text/html; charset='+d+'" />\n';if(d=e.getParam("fullpage_default_font_family"))c+="font-family: "+d+";";if(d=e.getParam("fullpage_default_font_size"))c+="font-size: "+d+";";if(d=e.getParam("fullpage_default_text_color"))c+="color: "+d+";";return a+("</head>\n<body"+(c?' style="'+c+'"':"")+">\n")}var n=tinymce.each,l=tinymce.html.Node,m,q;e.addCommand("mceFullPageProperties",function(){var a=
r();e.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(d){s(tinymce.extend(a,d.data))}})});e.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"});e.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",
context:"file"});e.on("BeforeSetContent",function(a){function d(a){return a.replace(/<\/?[A-Z]+/g,function(a){return a.toLowerCase()})}var c,g,f=a.content,h="",b=e.dom;if(!(a.selection||"raw"==a.format&&m||a.source_view&&e.getParam("fullpage_hide_in_source_view"))){f=f.replace(/<(\/?)BODY/gi,"<$1body");c=f.indexOf("<body");-1!=c?(c=f.indexOf(">",c),m=d(f.substring(0,c+1)),g=f.indexOf("</body",c),-1==g&&(g=f.length),a.content=f.substring(c+1,g),q=d(f.substring(g))):(m=u(),q="\n</body>\n</html>");a=
p();n(a.getAll("style"),function(a){a.firstChild&&(h+=a.firstChild.value)});(c=a.getAll("body")[0])&&b.setAttribs(e.getBody(),{style:c.attr("style")||"",dir:c.attr("dir")||"",vLink:c.attr("vlink")||"",link:c.attr("link")||"",aLink:c.attr("alink")||""});b.remove("fullpage_styles");var l=e.getDoc().getElementsByTagName("head")[0];h&&(b.add(l,"style",{id:"fullpage_styles"},h),c=b.get("fullpage_styles"),c.styleSheet&&(c.styleSheet.cssText=h));var k={};tinymce.each(l.getElementsByTagName("link"),function(a){"stylesheet"==
a.rel&&a.getAttribute("data-mce-fullpage")&&(k[a.href]=a)});tinymce.each(a.getAll("link"),function(a){var c=a.attr("href");k[c]||"stylesheet"!=a.attr("rel")||b.add(l,"link",{rel:"stylesheet",text:"text/css",href:c,"data-mce-fullpage":"1"});delete k[c]});tinymce.each(k,function(a){a.parentNode.removeChild(a)})}});e.on("GetContent",function(a){a.selection||a.source_view&&e.getParam("fullpage_hide_in_source_view")||(a.content=tinymce.trim(m)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(q))})});
