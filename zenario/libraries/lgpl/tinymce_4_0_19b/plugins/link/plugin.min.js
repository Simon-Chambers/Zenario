tinymce.PluginManager.add("link",function(b){function h(l){return function(){var g=b.settings.link_list;"string"==typeof g?tinymce.util.XHR.send({url:g,success:function(b){l(tinymce.util.JSON.parse(b))}}):l(g)}}function k(l){function g(a){var e=r.find("#text");(!e.value()||a.lastControl&&e.value()==a.lastControl.text())&&e.value(a.control.text());r.find("#href").value(a.control.value())}function k(){var a=[{text:"None",value:""}];tinymce.each(l,function(e){a.push({text:e.text||e.title,value:b.convertURL(e.value||
e.url,"href"),menu:e.menu})});return a}function h(c,e,x){var d,f=[];tinymce.each(b.settings[c]||x,function(b){var c={text:b.text||b.title,value:b.value};f.push(c);if(a[e]===b.value||!d&&b.selected)d=c});d&&!a[e]&&(a[e]=d.value,d.selected=!0);return f}function t(){m&&m.value(b.convertURL(this.value(),"href"));!s&&0===a.text.length&&n&&this.parent().parent().find("#text")[0].value(this.value())}var a={},p=b.selection,f=b.dom,q,c,s,r,n,u,m,v,w;q=p.getNode();c=f.getParent(q,"a[href]");n=function(a){var b=
p.getContent();if(/</.test(b)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(b)||-1==b.indexOf("href=")))return!1;if(a){a=a.childNodes;if(0===a.length)return!1;for(b=a.length-1;0<=b;b--)if(3!=a[b].nodeType)return!1}return!0}();a.text=s=c?c.innerText||c.textContent:p.getContent({format:"text"});a.href=c?f.getAttrib(c,"href"):"";a.target=c?f.getAttrib(c,"target"):b.settings.default_link_target||null;a.rel=c?f.getAttrib(c,"rel"):null;a["class"]=c?f.getAttrib(c,"class"):null;n&&(u={name:"text",type:"textbox",size:40,
label:"Text to display",classes:"link_text_to_display",onchange:function(){a.text=this.value()}});l&&(m={type:"listbox",label:"Link list",values:k(),onselect:g,value:b.convertURL(a.href,"href"),onPostRender:function(){m=this}});!1!==b.settings.target_list&&(w={name:"target",type:"listbox",label:"Target",values:h("target_list","target",[{text:"None",value:""},{text:"New window",value:"_blank"}])});b.settings.rel_list&&(v={name:"rel",type:"listbox",label:"Rel",values:h("rel_list","rel",[{text:"None",
value:""}])});q=b.settings.link_class_list?{name:"class",type:"listbox",label:"Class",values:h("link_class_list","class")}:{name:"class",type:"textbox",size:40,label:"CSS class name(s)"};r=b.windowManager.open({title:"Insert link",data:a,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:t,onkeyup:t},u,function(a){var c=[];tinymce.each(b.dom.select("a:not([href])"),function(b){(b=b.name||b.id)&&c.push({text:b,value:"#"+b,selected:-1!=a.indexOf("#"+b)})});
if(c.length)return c.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:c,onselect:g}}(a.href),m,v,w,q],onSubmit:function(h){function e(a,c){var d=b.selection.getRng();window.setTimeout(function(){b.windowManager.confirm(a,function(a){b.selection.setRng(d);c(a)})},0)}function g(){c?(b.focus(),n&&a.text!=s&&(c.innerText=a.text),f.setAttribs(c,{href:d,target:a.target?a.target:null,rel:a.rel?a.rel:null,"class":a["class"]?a["class"]:null}),p.select(c),b.undoManager.add()):
n?b.insertContent(f.createHTML("a",{href:d,target:a.target?a.target:null,rel:a.rel?a.rel:null,"class":a["class"]?a["class"]:null},f.encode(a.text))):b.execCommand("mceInsertLink",!1,{href:d,target:a.target,rel:a.rel?a.rel:null})}var d;a=tinymce.extend(a,h.data);(d=a.href)?0<d.indexOf("@")&&-1==d.indexOf("//")&&-1==d.indexOf("mailto:")?e("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(a){a&&(d="mailto:"+d);g()}):/^\s*www\./i.test(d)?e("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",
function(a){a&&(d="http://"+d);g()}):g():b.execCommand("unlink")}})}b.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:h(k),stateSelector:"a[href]"});b.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"});b.addShortcut("Ctrl+K","",h(k));this.showDialog=k;b.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:h(k),stateSelector:"a[href]",context:"insert",prependToContext:!0})});
