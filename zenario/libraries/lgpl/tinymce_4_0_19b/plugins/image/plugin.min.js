tinymce.PluginManager.add("image",function(c){function x(c,m){function u(c,g){e.parentNode&&e.parentNode.removeChild(e);m({width:c,height:g})}var e=document.createElement("img");e.onload=function(){u(e.clientWidth,e.clientHeight)};e.onerror=function(){u()};var g=e.style;g.visibility="hidden";g.position="fixed";g.bottom=g.left=0;g.width=g.height="auto";document.body.appendChild(e);e.src=c}function q(p){return function(){var m=c.settings.image_list;"string"==typeof m?tinymce.util.XHR.send({url:m,success:function(c){p(tinymce.util.JSON.parse(c))}}):
p(m)}}function w(p){function m(h,k,a){var r,d=[];tinymce.each(c.settings[h]||a,function(c){var h={text:c.text||c.title,value:c.value};d.push(h);if(b[k]===c.value||!r&&c.selected)r=h});r&&!b[k]&&(b[k]=r.value,r.selected=!0);return d}function u(){var b=[{text:"None",value:""}];tinymce.each(p,function(k){b.push({text:k.text||k.title,value:c.convertURL(k.value||k.url,"src"),menu:k.menu})});return b}function e(){var b,c,a,d;b=f.find("#width")[0];c=f.find("#height")[0];a=b.value();d=c.value();f.find("#constrain")[0].checked()&&
l&&n&&a&&d&&(l!=a?(d=Math.round(a/l*d),c.value(d)):(a=Math.round(d/n*a),b.value(a)));l=a;n=d}function g(){function h(a){function h(){a.onload=a.onerror=null;c.selection.select(a);c.nodeChanged()}a.onload=function(){b.width||b.height||d.setAttribs(a,{width:a.clientWidth,height:a.clientHeight});h()};a.onerror=h}q();e();b=tinymce.extend(b,f.toJSON());""===b.width&&(b.width=null);""===b.height&&(b.height=null);""===b.style&&(b.style=null);""===b.align&&(b.align=null);b={src:b.src,alt:b.alt,width:b.width,
height:b.height,style:b.style,"class":b["class"],align:b.align};b["class"]||delete b["class"];c.undoManager.transact(function(){b.src?(a?d.setAttribs(a,b):(b.id="__mcenew",c.focus(),c.selection.setContent(d.createHTML("img",b)),a=d.get("__mcenew"),d.setAttrib(a,"id",null)),h(a)):a&&(d.remove(a),c.focus(),c.nodeChanged())})}function v(b){b&&(b=b.replace(/px$/,""));return b}function q(){function b(a){0<a.length&&/^[0-9]+$/.test(a)&&(a+="px");return a}if(c.settings.image_advtab){var a=f.toJSON(),e=d.parseStyle(a.style);
delete e.margin;e["margin-top"]=e["margin-bottom"]=b(a.vspace);e["margin-left"]=e["margin-right"]=b(a.hspace);e["border-width"]=b(a.border);f.find("#style").value(d.serializeStyle(d.parseStyle(d.serializeStyle(e))))}}var f,b={},d=c.dom,a=c.selection.getNode(),l,n,s,t;l=d.getAttrib(a,"width");n=d.getAttrib(a,"height");"IMG"!=a.nodeName||a.getAttribute("data-mce-object")||a.getAttribute("data-mce-placeholder")?a=null:b={src:d.getAttrib(a,"src"),alt:d.getAttrib(a,"alt"),align:d.getAttrib(a,"align"),
"class":d.getAttrib(a,"class"),width:l,height:n};p&&(s={type:"listbox",label:"Image list",values:u(),value:b.src&&c.convertURL(b.src,"src"),onselect:function(a){var b=f.find("#alt");(!b.value()||a.lastControl&&b.value()==a.lastControl.text())&&b.value(a.control.text());f.find("#src").value(a.control.value())},onPostRender:function(){s=this}});t=c.settings.image_class_list?{name:"class",type:"listbox",label:"Class",values:m("image_class_list","class")}:{name:"class",type:"textbox",size:40,label:"CSS class name(s)"};
t=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:function(){s&&s.value(c.convertURL(this.value(),"src"));x(this.value(),function(a){a.width&&a.height&&(l=a.width,n=a.height,f.find("#width").value(l),f.find("#height").value(n))})}},s,{name:"alt",type:"textbox",label:"Image description",classes:"image_alt"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:e,
ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:e,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]},t,{type:"listbox",name:"align",label:"Alignment",values:[{text:"-- Not Set --",value:""},{text:"Left",value:"left"},{text:"Right",value:"right"},{text:"Middle",value:"middle"},{text:"Top",value:"top"},{text:"Bottom",value:"bottom"}]}];c.settings.image_advtab?(a&&(b.hspace=v(a.style.marginLeft||a.style.marginRight),
b.vspace=v(a.style.marginTop||a.style.marginBottom),b.border=v(a.style.borderWidth),b.style=c.dom.serializeStyle(c.dom.parseStyle(c.dom.getAttrib(a,"style")))),f=c.windowManager.open({title:"Insert/edit image",data:b,bodyType:"tabpanel",body:[{title:"General",type:"form",items:t},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:q},
items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:g})):f=c.windowManager.open({title:"Insert/edit image",data:b,body:t,onSubmit:g})}c.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:q(w),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"});c.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:q(w),context:"insert",prependToContext:!0})});
