(function(d){var k=d.Event;d.plugins.Paste=function(a){function l(b){var c,f=[],h=a.selection,e,g;a.getWin().focus();m&&(r=a.selection.getRng(),r.moveToBookmark(m),r.select());c=b.split(/\r?\n/);if(1<c.length&&(b="",d.each(c,function(a){b+="<p>"+a+"</p>"}),!d.isIE)){a.execCommand("Delete");h.setContent('<span id="marker"></span>');if(c=a.dom.getParent(a.dom.get("marker").parentNode,function(a){f.push(a);if(/^(p|h[1-6]|div)$/i.test(a.nodeName))return!0})){a.onPaste.dispatch({text:b});c=e="";for(g=
0;g<f.length;g++)c+="</"+f[g].nodeName.toLowerCase()+">";for(g=f.length-1;0<=g;g--)e+="<"+f[g].nodeName.toLowerCase()+">";b=c+b+e+'<span id="_caret">&nbsp;</span>';a.getBody().innerHTML=a.getBody().innerHTML.replace(/<span id=\"marker\"><\/span>/gi,b);c=a.dom.get("_caret");d.isGecko||c.scrollIntoView();e=a.getDoc().createRange();e.setStartBefore(c);e.setEndAfter(c);h.setRng(e);a.execCommand("Delete");return}h=a.dom.get("marker");h.parentNode.removeChild(h)}a.selection.setContent(b);a.onPaste.dispatch({text:b})}
function n(b){var c,f,d=a.selection;b=d.getSel();var e;c=a.getBody();c=a.dom.add(c,"div",{id:"_mcePaste",style:"position:absolute;left:-10000px;top:"+c.scrollTop},"&nbsp;");e=d.getRng();c=c.firstChild;f=a.getDoc().createRange();f.setStart(c,0);f.setEnd(c,1);b.removeAllRanges();b.addRange(f);window.setTimeout(function(){var b=a.dom.get("_mcePaste"),c;c=b.innerHTML;b.parentNode.removeChild(b);e&&d.setRng(e);l(c.replace(/[\r\n]/g,"").replace(/<(\/p|br\s*\/?)>/g,"\n").replace(/\x3c!--.*?--\x3e/g,"").replace(/<[^>]+>/g,
""))},0)}var m;a.onPaste=new d.Dispatcher(a);a.onInit.add(function(){d.isOpera||(/Firefox\/2/.test(navigator.userAgent)?k.add(a.getDoc(),"keydown",function(b){if((b.metaKey||b.ctrlKey)&&86==b.keyCode||b.shiftKey&&45==b.keyCode)d.isIE&&(m=a.selection.getRng().getBookmark()),n(b)},this):k.add(d.isIE?a.getBody():a.getDoc(),"paste",function(b){if(a.getWin().clipboardData)return l(a.getWin().clipboardData.getData("Text")),k.cancel(b);if(b.clipboardData)return l(b.clipboardData.getData("text/plain")),k.cancel(b);
n(b)}))})}})(punymce);
